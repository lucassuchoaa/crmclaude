version: "3.8"

# ===== DEV: docker compose up =====
# ===== PROD: docker compose --profile prod up -d =====

services:
  # ---------- Evolution API (dev + prod) ----------
  evolution-api:
    image: atendai/evolution-api:v2.2.3
    container_name: evolution-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      - WEBHOOK_GLOBAL_URL=${WEBHOOK_URL}
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - SERVER_PORT=8080
      - DEL_INSTANCE=false
      - LOG_LEVEL=WARN
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - crm-net

  # ---------- CRM App (prod only) ----------
  crm-app:
    profiles: ["prod"]
    build:
      context: .
      args:
        VITE_API_URL: /api
    container_name: crm-app
    restart: unless-stopped
    env_file: .env.production
    environment:
      - NODE_ENV=production
    volumes:
      - crm_data:/app/server/data
    depends_on:
      - evolution-api
    networks:
      - crm-net

  # ---------- Nginx + SSL (prod only) ----------
  nginx:
    profiles: ["prod"]
    image: nginx:alpine
    container_name: crm-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot_www:/var/www/certbot:ro
      - certbot_certs:/etc/letsencrypt:ro
    depends_on:
      - crm-app
    networks:
      - crm-net

  # ---------- Certbot SSL (prod only) ----------
  certbot:
    profiles: ["prod"]
    image: certbot/certbot
    container_name: crm-certbot
    volumes:
      - certbot_www:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  evolution_instances:
  evolution_store:
  crm_data:
  certbot_www:
  certbot_certs:

networks:
  crm-net:
    driver: bridge
